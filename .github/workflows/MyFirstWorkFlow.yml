name: my-first-workflow
on:
  push:  
    branches:
      - dev
      - feature-*
      - main
  workflow_dispatch: 
env:
  ENV_TYPE: dev
  APP_USER: thinknyx
  APP_PORT: 80


jobs:
  unit-test:
    name: unit-test
    runs-on: ubuntu-latest
    steps:
        - name: checkout    
          uses: actions/checkout@v5.0.0
        - name: setup python
          uses: actions/setup-python@v6.0.0
          with:
            python-version: '3.x'
        - name: install dependencies
          run: |
             python -m pip install --upgrade pip
             pip install -r requirements.txt
        - name: run unit tests
          run: |
             mkdir -p test-reports
             pytest --junitxml=test-reports/results.xml --cov=. --cov-report=xml --cov-report=term-missing -v
        - name: Upload test report
          uses: actions/upload-artifact@v5.0.0
          with:
            name: test-report
            path: test-reports/
  code-quality:
    name: code-quality
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      matrix:
        language: [python]
    steps:
        - name: checkout    
          uses: actions/checkout@v5.0.0
        - name: initialize codeql
          uses: github/codeql-action/init@v3
          with:
            languages: ${{ matrix.language }}
        - name: perform codeql analysis
          uses: github/codeql-action/analyze@v3
          with:
            category: "security"

  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}


  build:
    name: build
    runs-on: ubuntu-latest
    outputs :
     image-tag: ${{ steps.vars.outputs.IMAGE_TAG }}
    steps:
        - name: checkout    
          uses: actions/checkout@v5.0.0
        - name: docker buildx
          uses: docker/setup-buildx-action@v3.0.0
        - name: generate image tag
          id: vars
          run: |
            IMAGE_TAG=thinknyx:${GITHUB_SHA::8} 
            echo "IMAGE_TAG=thinknyx:${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        - name: build and push docker image
          uses: docker/build-push-action@v4.0.0
          with:
            context: .
            file: ./Dockerfile
            push: true
            tags: ${{ steps.vars.outputs.IMAGE_TAG }}  
        - name: Save image tag to artifact
          run: docker save ${{ steps.vars.outputs.IMAGE_TAG }} -o image.tar

        - name: upload image artifact
          uses: actions/upload-artifact@v5.0.0
          with:
            name: docker-image
            path: image.tar